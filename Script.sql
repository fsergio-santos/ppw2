--DROP TABLE ALUNO_AVALIACAO;
--DROP TABLE AVALIACAO;
--DROP TABLE MATRICULA;
--DROP TABLE DISCIPLINA;
DROP TABLE PROFESSOR;
DROP TABLE ALUNO;
DROP TABLE USUARIO;
DROP TABLE CIDADE;
DROP TABLE PERMISSIONS
DROP TABLE RECURSO;
DROP TABLE USUARIO_ROLE;
DROP TABLE ROLE;


-- TABELA DE DADOS 

CREATE TABLE CIDADE (
	ID_CIDADE INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL CONSTRAINT PK_CIDADE PRIMARY KEY,
    COD_CIDADE VARCHAR2(10) UNIQUE NOT NULL,
    NOME_CIDADE VARCHAR2(50),
    CREATED_AT DATE DEFAULT SYSDATE,
    UPDATED_AT DATE DEFAULT SYSDATE
);

CREATE TABLE USUARIO (
    ID_USUARIO INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL CONSTRAINT PK_USUARIO PRIMARY KEY,
    COD_USUARIO VARCHAR2(10) UNIQUE NOT NULL,
    NOME_USUARIO VARCHAR2(50),
    EMAIL VARCHAR2(100),
    SENHA VARCHAR2(20),
    FOTO VARCHAR2(200),
    TIPO INTEGER DEFAULT 1 NOT NULL, --1(PROFESSOR), 2(ALUNO)
    ID_CIDADE INTEGER NOT NULL,
    CONSTRAINT FK_USUARIO_CIDADE FOREIGN KEY (ID_CIDADE) REFERENCES CIDADE,
    ATIVO INTEGER DEFAULT 1,
    CREATED_AT DATE DEFAULT SYSDATE,
    UPDATED_AT DATE DEFAULT SYSDATE
);  

CREATE TABLE ALUNO (
    ID_ALUNO INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL CONSTRAINT PK_ALUNO PRIMARY KEY,
    COD_ALUNO VARCHAR2(10) UNIQUE NOT NULL,
    NOME_ALUNO VARCHAR2(50),
    IDADE INTEGER,
    ID_USUARIO INTEGER NOT NULL,
       CONSTRAINT FK_ALUNO_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO,
    CREATED_AT DATE DEFAULT SYSDATE,
    UPDATED_AT DATE DEFAULT SYSDATE
); 

CREATE TABLE PROFESSOR (
    ID_PROFESSOR INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL CONSTRAINT  PK_PROFESSOR PRIMARY KEY,
    COD_PROFESSOR VARCHAR2(10) UNIQUE NOT NULL,
    NOME_PROFESSOR VARCHAR2(50),
    ID_USUARIO INTEGER NOT NULL,
       CONSTRAINT FK_PROFESSOR_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO,
    CREATED_AT DATE DEFAULT SYSDATE,
    UPDATED_AT DATE DEFAULT SYSDATE
); 

-- TABELA PARA IMPLEMENTAÇÃO DA TÉCNICA RBAC

CREATE TABLE ROLE (
    ID_ROLE INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL CONSTRAINT PK_ROLE PRIMARY KEY,
    NOME_ROLE VARCHAR2(50) UNIQUE NOT NULL,
    CREATED_AT DATE DEFAULT SYSDATE,
    UPDATE_AT DATE DEFAULT SYSDATE
);

CREATE TABLE USUARIO_ROLE (
    USUARIO_ID INTEGER NOT NULL,
    ROLE_ID INTEGER NOT NULL,
    CREATED_AT DATE DEFAULT SYSDATE,
    UPDATE_AT DATE DEFAULT SYSDATE,
    PRIMARY KEY (USUARIO_ID, ROLE_ID),
    CONSTRAINT FK_USUARIO_ROLE_USUARIO FOREIGN KEY (USUARIO_ID) REFERENCES USUARIO(ID_USUARIO),
    CONSTRAINT FK_USUARIO_ROLE_ROLE FOREIGN KEY (ROLE_ID) REFERENCES ROLE(ID_ROLE)
);

CREATE TABLE RECURSO (
    ID_RECURSO INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL CONSTRAINT PK_RECURSO PRIMARY KEY,
    NOME_RECURSO VARCHAR2(100) UNIQUE NOT NULL,
    CREATED_AT DATE DEFAULT SYSDATE,
    UPDATE_AT DATE DEFAULT SYSDATE
);

CREATE TABLE PERMISSIONS (
    ID_PERMISSION INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL CONSTRAINT PK_PERMISSIONS PRIMARY KEY,
    ROLE_ID INTEGER NOT NULL,
    RECURSO_ID INTEGER NOT NULL,
    ACTION VARCHAR2(20) NOT NULL,       -- CREATE, READ, UPDATE, DELETE
    POSSESSION VARCHAR2(20) NOT NULL,   -- OWN ou ANY
    ATTRIBUTES VARCHAR2(4000),          -- atributos permitidos (separados por vírgula)
    CREATED_AT DATE DEFAULT SYSDATE,
    UPDATE_AT DATE DEFAULT SYSDATE,
    CONSTRAINT FK_PERMISSIONS_ROLE FOREIGN KEY (ROLE_ID) REFERENCES ROLE(ID_ROLE),
    CONSTRAINT FK_PERMISSIONS_RECURSO FOREIGN KEY (RECURSO_ID) REFERENCES RECURSO(ID_RECURSO)
);
