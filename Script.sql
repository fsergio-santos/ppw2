--DROP TABLE ALUNO_AVALIACAO;
--DROP TABLE AVALIACAO;
--DROP TABLE MATRICULA;
--DROP TABLE DISCIPLINA;
DROP TABLE PROFESSOR CASCADE CONSTRAINTS PURGE;
DROP TABLE ALUNO CASCADE CONSTRAINTS PURGE;
DROP TABLE USUARIO CASCADE CONSTRAINTS PURGE;
DROP TABLE CIDADE CASCADE CONSTRAINTS PURGE;
DROP TABLE PERMISSIONS CASCADE CONSTRAINTS PURGE;
DROP TABLE RECURSO CASCADE CONSTRAINTS PURGE;
DROP TABLE USUARIO_ROLE CASCADE CONSTRAINTS PURGE;
DROP TABLE ROLE CASCADE CONSTRAINTS PURGE;


-- TABELA DE DADOS 

CREATE TABLE CIDADE (
	ID_CIDADE NUMBER GENERATED BY DEFAULT AS IDENTITY NOT NULL CONSTRAINT PK_CIDADE PRIMARY KEY,
    COD_CIDADE VARCHAR2(10) UNIQUE NOT NULL,
    NOME_CIDADE VARCHAR2(50),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE USUARIO (
    ID_USUARIO NUMBER GENERATED BY DEFAULT AS IDENTITY NOT NULL CONSTRAINT PK_USUARIO PRIMARY KEY,
    COD_USUARIO VARCHAR2(10) UNIQUE NOT NULL,
    NOME_USUARIO VARCHAR2(50),
    EMAIL VARCHAR2(100),
    SENHA VARCHAR2(20),
    FOTO VARCHAR2(200),
    TIPO NUMBER DEFAULT 1 NOT NULL, --1(PROFESSOR), 2(ALUNO)
    ID_CIDADE NUMBER NOT NULL,
    CONSTRAINT FK_USUARIO_CIDADE FOREIGN KEY (ID_CIDADE) REFERENCES CIDADE,
    ATIVO NUMBER DEFAULT 1,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);  

CREATE TABLE ALUNO (
    ID_ALUNO NUMBER GENERATED BY DEFAULT AS IDENTITY NOT NULL CONSTRAINT PK_ALUNO PRIMARY KEY,
    COD_ALUNO VARCHAR2(10) UNIQUE NOT NULL,
    NOME_ALUNO VARCHAR2(50),
    IDADE NUMBER,
    ID_USUARIO NUMBER NOT NULL,
       CONSTRAINT FK_ALUNO_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
); 

CREATE TABLE PROFESSOR (
    ID_PROFESSOR NUMBER GENERATED BY DEFAULT AS IDENTITY NOT NULL CONSTRAINT  PK_PROFESSOR PRIMARY KEY,
    COD_PROFESSOR VARCHAR2(10) UNIQUE NOT NULL,
    NOME_PROFESSOR VARCHAR2(50),
    ID_USUARIO NUMBER NOT NULL,
       CONSTRAINT FK_PROFESSOR_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
); 

-- TABELA PARA IMPLEMENTAÇÃO DA TÉCNICA RBAC

CREATE TABLE ROLE (
    ID_ROLE NUMBER GENERATED BY DEFAULT AS IDENTITY NOT NULL CONSTRAINT PK_ROLE PRIMARY KEY,
    NOME_ROLE VARCHAR2(50) UNIQUE NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE USUARIO_ROLE (
    USUARIO_ID NUMBER NOT NULL,
    ROLE_ID NUMBER NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (USUARIO_ID, ROLE_ID),
    CONSTRAINT FK_USUARIO_ROLE_USUARIO FOREIGN KEY (USUARIO_ID) REFERENCES USUARIO(ID_USUARIO),
    CONSTRAINT FK_USUARIO_ROLE_ROLE FOREIGN KEY (ROLE_ID) REFERENCES ROLE(ID_ROLE)
);

CREATE TABLE RECURSO (
    ID_RECURSO NUMBER GENERATED BY DEFAULT AS IDENTITY NOT NULL CONSTRAINT PK_RECURSO PRIMARY KEY,
    NOME_RECURSO VARCHAR2(100) UNIQUE NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE PERMISSIONS (
    ID_PERMISSION NUMBER GENERATED BY DEFAULT AS IDENTITY NOT NULL CONSTRAINT PK_PERMISSIONS PRIMARY KEY,
    ROLE_ID NUMBER NOT NULL,
    RECURSO_ID NUMBER NOT NULL,
    ACTION VARCHAR2(20) NOT NULL,       -- CREATE, READ, UPDATE, DELETE
    POSSESSION VARCHAR2(20) NOT NULL,   -- OWN ou ANY
    ATTRIBUTES VARCHAR2(4000),          -- atributos permitidos (separados por vírgula)
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT FK_PERMISSIONS_ROLE FOREIGN KEY (ROLE_ID) REFERENCES ROLE(ID_ROLE),
    CONSTRAINT FK_PERMISSIONS_RECURSO FOREIGN KEY (RECURSO_ID) REFERENCES RECURSO(ID_RECURSO)
);

-- purge recyclebin; --> 
